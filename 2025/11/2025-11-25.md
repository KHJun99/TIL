# 2025-11-25 TIL

# âœ… ì˜¤ëŠ˜ í•œ ì¼
- Ajaxì™€ Django ì„œë²„ ì—°ë™ ë°©ë²• í•™ìŠµ
- JsonResponseë¥¼ ì‚¬ìš©í•œ JSON ë°ì´í„° ì‘ë‹µ í•™ìŠµ
- data-* ì†ì„±ì„ í™œìš©í•œ HTMLê³¼ JavaScript ê°„ ë°ì´í„° ì „ë‹¬
- CSRF í† í°ì„ Axios í—¤ë”ì— í¬í•¨í•˜ì—¬ ì „ì†¡í•˜ëŠ” ë°©ë²• í•™ìŠµ
- ë¹„ë™ê¸° íŒ”ë¡œìš° ê¸°ëŠ¥ êµ¬í˜„ ì‹¤ìŠµ
- ë¹„ë™ê¸° ì¢‹ì•„ìš” ê¸°ëŠ¥ êµ¬í˜„ ì‹¤ìŠµ (ë²„ë¸”ë§ í™œìš©)
- event.targetê³¼ event.currentTargetì˜ ì°¨ì´ ë³µìŠµ

# ğŸ“š ë°°ìš´ ì 
- Django view í•¨ìˆ˜ì—ì„œ HTML ëŒ€ì‹  JsonResponseë¥¼ ë°˜í™˜í•˜ë©´ JavaScriptì™€ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŒ
- data-* ì†ì„±ì€ HTML ìš”ì†Œì— ì‚¬ìš©ì ì§€ì • ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³ , JavaScriptì—ì„œ dataset ì†ì„±ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥
- data-user-idëŠ” JavaScriptì—ì„œ dataset.userIdë¡œ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ë³€í™˜ë˜ì–´ ì ‘ê·¼ë¨
- CSRF í† í°ì€ Axios ìš”ì²­ì˜ headersì— {'X-CSRFToken': csrftoken} í˜•íƒœë¡œ í¬í•¨í•´ì•¼ í•¨
- ì—¬ëŸ¬ ê°œì˜ ë²„íŠ¼ì„ íš¨ìœ¨ì ìœ¼ë¡œ ê´€ë¦¬í•˜ë ¤ë©´ ë²„ë¸”ë§ì„ í™œìš©í•˜ì—¬ ê³µí†µ ë¶€ëª¨ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•˜ë‚˜ë§Œ ë“±ë¡
- event.targetì€ ì‹¤ì œ í´ë¦­ëœ ìš”ì†Œ, event.currentTargetì€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì—°ê²°ëœ ìš”ì†Œë¥¼ ê°€ë¦¬í‚´
- Ajax ìš”ì²­ì¸ì§€ í™•ì¸í•˜ëŠ” is_ajax() ë©”ì„œë“œëŠ” í˜„ì¬ Djangoì—ì„œ ê¶Œì¥ë˜ì§€ ì•ŠìŒ
- ê°œë°œì ë„êµ¬ì˜ Network íƒ­ì—ì„œ XHR ìš”ì²­ê³¼ ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
- querySelectorAll()ê³¼ forEach()ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ë³´ë‹¤ ë²„ë¸”ë§ì´ ë” íš¨ìœ¨ì ì„

# ğŸ“Œ í•µì‹¬ ê°œë…
- **JsonResponse**: Djangoì—ì„œ JSON í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì‘ë‹µí•˜ëŠ” ê°ì²´
- **data-* ì†ì„±**: HTML ìš”ì†Œì— ì‚¬ìš©ì ì§€ì • ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì†ì„± (JavaScriptì—ì„œ datasetìœ¼ë¡œ ì ‘ê·¼)
- **CSRF í† í° ì „ì†¡**: Axios ìš”ì²­ ì‹œ headersì— X-CSRFTokenì„ í¬í•¨í•˜ì—¬ ì „ì†¡
- **XHR (XMLHttpRequest)**: ì›¹ ë¸Œë¼ìš°ì €ì™€ ì„œë²„ ê°„ ë¹„ë™ê¸° í†µì‹ ì„ ê°€ëŠ¥í•˜ê²Œ í•˜ëŠ” ê°ì²´
- **event.target**: ì‹¤ì œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•œ ìš”ì†Œ (ë²„ë¸”ë§ ì¤‘ì—ë„ ë³€í•˜ì§€ ì•ŠìŒ)
- **event.currentTarget**: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì—°ê²°ëœ ìš”ì†Œ (thisì™€ ë™ì¼)
- **ì´ë²¤íŠ¸ ë²„ë¸”ë§**: ìì‹ ìš”ì†Œì—ì„œ ë°œìƒí•œ ì´ë²¤íŠ¸ê°€ ë¶€ëª¨ ìš”ì†Œë¡œ ì „íŒŒë˜ëŠ” í˜„ìƒ
- **dataset**: data-* ì†ì„±ì— ì €ì¥ëœ ê°’ì„ JavaScriptì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì†ì„±
- **preventDefault()**: ì´ë²¤íŠ¸ì˜ ê¸°ë³¸ ë™ì‘(form ì œì¶œ, í˜ì´ì§€ ì´ë™ ë“±)ì„ ì·¨ì†Œí•˜ëŠ” ë©”ì„œë“œ

# ğŸ’¡ ì˜ˆì‹œ ì½”ë“œ

```html
<!-- 1. ë¹„ë™ê¸° íŒ”ë¡œìš° êµ¬í˜„ - HTML -->
<!-- accounts/profile.html -->

<!-- data-* ì†ì„±ìœ¼ë¡œ user pk ì „ë‹¬ -->
<form id="follow-form" data-user-id="{{ person.pk }}">
  {% csrf_token %}
  {% if request.user in person.followers.all %}
    <input type="submit" value="Unfollow">
  {% else %}
    <input type="submit" value="Follow">
  {% endif %}
</form>

<!-- íŒ”ë¡œì›Œ/íŒ”ë¡œì‰ ìˆ˜ í‘œì‹œ (id ì†ì„± ë¶€ì—¬) -->
<div>
  íŒ”ë¡œì‰: <span id="followings-count">{{ person.followings.all|length }}</span> /
  íŒ”ë¡œì›Œ: <span id="followers-count">{{ person.followers.all|length }}</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // form ìš”ì†Œ ì„ íƒ
  const formTag = document.querySelector('#follow-form');
  
  // submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  formTag.addEventListener('submit', function(event) {
    event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë™ì‘ ì·¨ì†Œ
    
    // data-* ì†ì„±ì—ì„œ userId ê°€ì ¸ì˜¤ê¸°
    const userId = event.currentTarget.dataset.userId;
    // ë˜ëŠ”: const userId = this.dataset.userId;
    // ë˜ëŠ”: const userId = formTag.dataset.userId;
    
    // Axiosë¡œ ë¹„ë™ê¸° ìš”ì²­
    axios({
      method: 'post',
      url: `/accounts/${userId}/follow/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then((response) => {
        console.log(response);
        console.log(response.data);
        
        const isFollowed = response.data.is_followed;
        const followBtn = document.querySelector('input[type=submit]');
        
        // íŒ”ë¡œìš° ë²„íŠ¼ í† ê¸€
        if (isFollowed === true) {
          followBtn.value = 'Unfollow';
        } else {
          followBtn.value = 'Follow';
        }
        
        // íŒ”ë¡œì›Œ/íŒ”ë¡œì‰ ìˆ˜ ì—…ë°ì´íŠ¸
        const followingsCountTag = document.querySelector('#followings-count');
        const followersCountTag = document.querySelector('#followers-count');
        
        followingsCountTag.textContent = response.data.followings_count;
        followersCountTag.textContent = response.data.followers_count;
      })
      .catch((error) => {
        console.log(error);
      });
  });
</script>
```

```python
# 1. ë¹„ë™ê¸° íŒ”ë¡œìš° êµ¬í˜„ - Django view
# accounts/views.py

from django.http import JsonResponse
from django.contrib.auth.decorators import login_required

@login_required
def follow(request, user_pk):
    person = User.objects.get(pk=user_pk)
    
    if request.user != person:
        if request.user in person.followers.all():
            person.followers.remove(request.user)
            is_followed = False
        else:
            person.followers.add(request.user)
            is_followed = True
        
        # JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µ
        context = {
            'is_followed': is_followed,
            'followings_count': person.followings.count(),
            'followers_count': person.followers.count(),
        }
        return JsonResponse(context)
    
    # redirect ëŒ€ì‹  JsonResponse ì‚¬ìš©
    # return redirect('accounts:profile', person.username)
```

```html
<!-- 2. ë¹„ë™ê¸° ì¢‹ì•„ìš” êµ¬í˜„ (ë²„ë¸”ë§ í™œìš©) - HTML -->
<!-- articles/index.html -->

<!-- ëª¨ë“  formì„ ê°ì‹¸ëŠ” ê³µí†µ ë¶€ëª¨ ìš”ì†Œ -->
<article class="article-container">
  {% for article in articles %}
    <h3>{{ article.title }}</h3>
    <p>{{ article.content }}</p>
    
    <!-- ê° formì— data-article-id ì†ì„± ë¶€ì—¬ -->
    <form data-article-id="{{ article.pk }}">
      {% csrf_token %}
      {% if request.user in article.like_users.all %}
        <!-- ê³ ìœ í•œ id ì†ì„± ë¶€ì—¬ (article pk ì¡°í•©) -->
        <input type="submit" value="ì¢‹ì•„ìš” ì·¨ì†Œ" id="like-{{ article.pk }}">
      {% else %}
        <input type="submit" value="ì¢‹ì•„ìš”" id="like-{{ article.pk }}">
      {% endif %}
    </form>
    <hr>
  {% endfor %}
</article>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // ê³µí†µ ë¶€ëª¨ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•˜ë‚˜ë§Œ ë“±ë¡ (ë²„ë¸”ë§ í™œìš©)
  const articleContainer = document.querySelector('.article-container');
  
  articleContainer.addEventListener('submit', function(event) {
    event.preventDefault();
    
    // event.targetìœ¼ë¡œ ì‹¤ì œ í´ë¦­ëœ formì˜ article id ê°€ì ¸ì˜¤ê¸°
    const articleId = event.target.dataset.articleId;
    
    axios({
      method: 'post',
      url: `/articles/${articleId}/likes/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then((response) => {
        console.log(response);
        const isLiked = response.data.is_liked;
        
        // í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš” ë²„íŠ¼ë§Œ ì„ íƒ
        const likeBtn = document.querySelector(`#like-${articleId}`);
        
        if (isLiked === true) {
          likeBtn.value = 'ì¢‹ì•„ìš” ì·¨ì†Œ';
        } else {
          likeBtn.value = 'ì¢‹ì•„ìš”';
        }
      })
      .catch((error) => {
        console.log(error);
      });
  });
</script>
```

```python
# 2. ë¹„ë™ê¸° ì¢‹ì•„ìš” êµ¬í˜„ - Django view
# articles/views.py

from django.http import JsonResponse
from django.contrib.auth.decorators import login_required

@login_required
def likes(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    
    if request.user in article.like_users.all():
        article.like_users.remove(request.user)
        is_liked = False
    else:
        article.like_users.add(request.user)
        is_liked = True
    
    context = {
        'is_liked': is_liked,
    }
    return JsonResponse(context)
```

```javascript
// 3. ë²„ë¸”ë§ì„ í™œìš©í•˜ì§€ ì•ŠëŠ” ë°©ì‹ (ë¹„íš¨ìœ¨ì )
const formTags = document.querySelectorAll('.like-forms');
const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// forEachë¡œ ëª¨ë“  ë²„íŠ¼ì— ê°œë³„ì ìœ¼ë¡œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (ë¹„íš¨ìœ¨ì )
formTags.forEach((formTag) => {
  formTag.addEventListener('submit', function(event) {
    event.preventDefault();
    const articleId = formTag.dataset.articleId;
    
    axios({
      method: 'post',
      url: `/articles/${articleId}/likes/`,
      headers: {'X-CSRFToken': csrftoken},
    })
      .then((response) => {
        const isLiked = response.data.is_liked;
        const likeBtn = document.querySelector(`#like-${articleId}`);
        
        if (isLiked === true) {
          likeBtn.value = 'ì¢‹ì•„ìš” ì·¨ì†Œ';
        } else {
          likeBtn.value = 'ì¢‹ì•„ìš”';
        }
      });
  });
});
```

# ğŸ› ï¸ ì´ìŠˆ & í•´ê²°
| ğŸ ë¬¸ì œ ìƒí™© | ğŸ” ì›ì¸ | ğŸ’¡ í•´ê²° ë°©ë²• |
|--------------|--------|--------------|
| Axios ìš”ì²­ ì‹œ 403 Forbidden ì—ëŸ¬ ë°œìƒ | CSRF í† í°ì„ í—¤ë”ì— í¬í•¨í•˜ì§€ ì•Šì•„ Djangoê°€ ìš”ì²­ì„ ê±°ë¶€í•¨ | headersì— {'X-CSRFToken': csrftoken}ì„ í¬í•¨í•˜ì—¬ ì „ì†¡. csrftokenì€ `document.querySelector('[name=csrfmiddlewaretoken]').value`ë¡œ ê°€ì ¸ì˜´ |
| data-user-idë¡œ ì €ì¥í•œ ê°’ì„ dataset.user-idë¡œ ì ‘ê·¼í–ˆë”ë‹ˆ ì—ëŸ¬ ë°œìƒ | data-* ì†ì„±ì€ JavaScriptì—ì„œ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ë³€í™˜ë¨ | dataset.userIdë¡œ ì ‘ê·¼. í•˜ì´í”ˆ(-)ì´ ì œê±°ë˜ê³  ë‹¤ìŒ ê¸€ìê°€ ëŒ€ë¬¸ìë¡œ ë³€í™˜ë¨ |
| ì—¬ëŸ¬ ì¢‹ì•„ìš” ë²„íŠ¼ ì¤‘ ì–´ë–¤ ë²„íŠ¼ì„ ëˆŒë €ëŠ”ì§€ êµ¬ë¶„ì´ ì•ˆ ë¨ | ë²„íŠ¼ë“¤ì´ ëª¨ë‘ ê°™ì€ ì„ íƒìë¥¼ ê°€ì§€ê³  ìˆìŒ | ê° ë²„íŠ¼ì— id="like-{{ article.pk }}"ì²˜ëŸ¼ ê³ ìœ í•œ id ì†ì„±ì„ ë¶€ì—¬í•˜ê³ , JavaScriptì—ì„œ `#like-${articleId}`ë¡œ ì„ íƒ |
| ë²„ë¸”ë§ì„ ì‚¬ìš©í–ˆëŠ”ë° event.currentTargetìœ¼ë¡œ ì ‘ê·¼í–ˆë”ë‹ˆ í•­ìƒ ë¶€ëª¨ ìš”ì†Œë§Œ ì„ íƒë¨ | event.currentTargetì€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì—°ê²°ëœ ìš”ì†Œë¥¼ ê°€ë¦¬í‚´ | event.targetì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ í´ë¦­ëœ ìš”ì†Œì— ì ‘ê·¼ |
| JsonResponse ëŒ€ì‹  renderë¥¼ ì‚¬ìš©í–ˆë”ë‹ˆ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë¨ | renderëŠ” HTML í˜ì´ì§€ë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ Ajaxê°€ ì•„ë‹Œ ì¼ë°˜ ìš”ì²­ì²˜ëŸ¼ ë™ì‘ | return JsonResponse(context)ë¡œ ë³€ê²½í•˜ì—¬ JSON ë°ì´í„°ë§Œ ë°˜í™˜ |