# 2025-11-13 TIL

# âœ… ì˜¤ëŠ˜ í•œ ì¼
- DRFì—ì„œ N:1 ê´€ê³„ë¥¼ í‘œí˜„í•˜ëŠ” Comment ëª¨ë¸ ì •ì˜ ë° êµ¬í˜„
- CommentSerializerë¥¼ ì‚¬ìš©í•œ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ(GET) ë° ìƒì„¸ ì¡°íšŒ êµ¬í˜„
- read_only_fieldsë¥¼ í™œìš©í•œ ì™¸ë˜ í‚¤ í•„ë“œ ì²˜ë¦¬ ë°©ë²• í•™ìŠµ
- save() ë©”ì„œë“œì— ì¶”ê°€ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ì—¬ ëŒ“ê¸€ ìƒì„±(POST) êµ¬í˜„
- ëŒ“ê¸€ ìˆ˜ì •(PUT) ë° ì‚­ì œ(DELETE) ê¸°ëŠ¥ êµ¬í˜„
- ì¤‘ì²© Serializerë¥¼ í™œìš©í•œ ì‘ë‹µ ë°ì´í„° êµ¬ì¡° ê°œì„ 
- annotateì™€ Countë¥¼ ì‚¬ìš©í•œ ì§‘ê³„ í•„ë“œ ì¶”ê°€ ë°©ë²• í•™ìŠµ
- SerializerMethodFieldë¥¼ í™œìš©í•œ ì»¤ìŠ¤í…€ í•„ë“œ ìƒì„±
- get_object_or_404, get_list_or_404ë¥¼ í™œìš©í•œ ì ì ˆí•œ 404 ì‘ë‹µ ì²˜ë¦¬
- drf-spectacular ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ API ë¬¸ì„œ ìë™í™” (Swagger, ReDoc)
- OAS(OpenAPI Specification) ê¸°ë°˜ API ë¬¸ì„œí™” ë°©ë²• ì´í•´

# ğŸ“š ë°°ìš´ ì 
- **N:1 ê´€ê³„ì˜ ì˜ë¯¸**: ì—¬ëŸ¬ ëŒ“ê¸€(N)ì´ í•˜ë‚˜ì˜ ê²Œì‹œê¸€(1)ì„ ì°¸ì¡°í•˜ëŠ” ê´€ê³„, ForeignKeyë¡œ êµ¬í˜„
- **read_only_fieldsì˜ ì¤‘ìš”ì„±**: í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ ìˆ˜ì •í•˜ë©´ ì•ˆ ë˜ëŠ” í•„ë“œë¥¼ ì‘ë‹µ ì „ìš©ìœ¼ë¡œ ì§€ì •
- **save() ë©”ì„œë“œì˜ ìœ ì—°ì„±**: ì¶”ê°€ ë°ì´í„°ë¥¼ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬ ì™¸ë˜ í‚¤ ë“±ì„ ì„¤ì • ê°€ëŠ¥
- **ì¤‘ì²© Serializer**: ì™¸ë˜ í‚¤ í•„ë“œë¥¼ IDê°€ ì•„ë‹Œ ê°ì²´ í˜•íƒœë¡œ ì‘ë‹µ êµ¬ì¡° ê°œì„ 
- **annotateì˜ ì—­í• **: ì¿¼ë¦¬ ë‹¨ê³„ì—ì„œ ì§‘ê³„ ê³„ì‚° í•„ë“œë¥¼ ë™ì ìœ¼ë¡œ ìƒì„± (DB ë ˆë²¨ ì²˜ë¦¬)
- **SerializerMethodField**: ëª¨ë¸ì— ì—†ëŠ” í•„ë“œë¥¼ ì‘ë‹µì— ì¶”ê°€í•˜ëŠ” ì½ê¸° ì „ìš© í•„ë“œ
- **get_<í•„ë“œëª…> ë©”ì„œë“œ**: SerializerMethodField ì‚¬ìš© ì‹œ ë°˜ë“œì‹œ ì •ì˜í•´ì•¼ í•˜ëŠ” ë©”ì„œë“œ
- **get_object_or_404 vs ì¼ë°˜ get()**: 404 ì‘ë‹µìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ ë¶€ì¬ë¥¼ ëª…í™•íˆ ì „ë‹¬
- **get_list_or_404 vs ì¼ë°˜ all()**: ë¹ˆ ë¦¬ìŠ¤íŠ¸ ëŒ€ì‹  404 ì‘ë‹µìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ ë¶€ì¬ ëª…í™•í™”
- **Viewì™€ Serializerì˜ ì—­í•  ë¶„ë¦¬**: ViewëŠ” ë°ì´í„° ì¤€ë¹„ ë° ì¿¼ë¦¬ ìµœì í™”, SerializerëŠ” ê°€ê³µ ë° í‘œí˜„
- **API ë¬¸ì„œí™”ì˜ ì¤‘ìš”ì„±**: Swagger/ReDocìœ¼ë¡œ API ì‚¬ìš©ë²•ì„ ì‹œê°ì ìœ¼ë¡œ ì œê³µ
- **"ì„¤ê³„ ìš°ì„ " ì ‘ê·¼ë²•**: ëª…ì„¸ ì‘ì„± í›„ ì½”ë“œ êµ¬í˜„ìœ¼ë¡œ ì¼ê´€ì„± ìœ ì§€

# ğŸ“Œ í•µì‹¬ ê°œë…
- **ForeignKey**: ë‹¤ë¥¸ ëª¨ë¸ì„ ì°¸ì¡°í•˜ì—¬ N:1 ê´€ê³„ë¥¼ ì„¤ì •í•˜ëŠ” Django ëª¨ë¸ í•„ë“œ
- **ì—­ì°¸ì¡° (related_name)**: ì°¸ì¡°ëœ ëª¨ë¸ì—ì„œ ì—­ìœ¼ë¡œ ì—°ê²°ëœ ë°ì´í„° ì¡°íšŒ (article.comment_set)
- **read_only_fields**: í´ë¼ì´ì–¸íŠ¸ ìˆ˜ì • ë¶ˆê°€, ì‘ë‹µì—ë§Œ í¬í•¨ë˜ëŠ” í•„ë“œ ì§€ì •
- **ì¤‘ì²© Serializer**: ì™¸ë˜ í‚¤ í•„ë“œë¥¼ ë‹¤ë¥¸ Serializerë¡œ ì¬ì •ì˜í•˜ì—¬ ìƒì„¸ ì •ë³´ ì œê³µ
- **annotate**: ORM í•¨ìˆ˜, ì¿¼ë¦¬ ê²°ê³¼ì— ì§‘ê³„ ê³„ì‚° í•„ë“œ ë™ì  ìƒì„±
- **Count**: annotateì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ê´€ë ¨ ê°ì²´ ê°œìˆ˜ ì§‘ê³„
- **SerializerMethodField**: ë©”ì„œë“œë¥¼ í†µí•´ ì‘ë‹µìš© ì»¤ìŠ¤í…€ í•„ë“œ ìƒì„±í•˜ëŠ” ì½ê¸° ì „ìš© í•„ë“œ
- **get_<í•„ë“œëª…> ë©”ì„œë“œ**: SerializerMethodFieldì˜ ê°’ì„ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ (í•„ìˆ˜)
- **get_object_or_404**: ê°ì²´ ì—†ì„ ì‹œ 404 ì˜ˆì™¸ ë°œìƒ (500 ëŒ€ì‹  ëª…í™•í•œ ì‘ë‹µ)
- **get_list_or_404**: í•„í„° ê²°ê³¼ ì—†ì„ ì‹œ 404 ì˜ˆì™¸ ë°œìƒ (ë¹ˆ ë¦¬ìŠ¤íŠ¸ ëŒ€ì‹  ëª…í™•í•œ ì‘ë‹µ)
- **OAS (OpenAPI Specification)**: RESTful APIë¥¼ ì„¤ëª…í•˜ê³  ì‹œê°í™”í•˜ëŠ” í‘œì¤€í™”ëœ ë°©ë²•
- **drf-spectacular**: DRFì™€ OAS 3.0 êµ¬ì¡° ìƒì„±ì„ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
- **Swagger**: OAS ê¸°ë°˜ API ë¬¸ì„œ ìƒì„± ì˜¤í”ˆì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬
- **ReDoc**: OAS ê¸°ë°˜ API ë¬¸ì„œ ìƒì„± ì˜¤í”ˆì†ŒìŠ¤ í”„ë ˆì„ì›Œí¬

# ğŸ’¡ ì˜ˆì‹œ ì½”ë“œ

**Comment ëª¨ë¸ ì •ì˜ - N:1 ê´€ê³„**
```python
# articles/models.py
from django.db import models

class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class Comment(models.Model):
    # ForeignKeyë¡œ N:1 ê´€ê³„ ì„¤ì •
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    content = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.content
```

**ë§ˆì´ê·¸ë ˆì´ì…˜ ë° ë°ì´í„° ì¤€ë¹„**
```bash
# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
$ python manage.py makemigrations
# Migrations for 'articles':
#   articles\migrations\0001_initial.py
#     + Create model Article
#     + Create model Comment

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
$ python manage.py migrate
# Operations to perform:
#   Apply all migrations: admin, articles, auth, contenttypes, sessions
# Running migrations:
#   Applying contenttypes.0001_initial... OK

# Fixtures ë°ì´í„° ë¡œë“œ
$ python manage.py loaddata articles.json comments.json
# Installed 40 object(s) from 2 fixture(s)
```

**CommentSerializer ì •ì˜ - ê¸°ë³¸**
```python
# articles/serializers.py
from rest_framework import serializers
from .models import Article, Comment

class CommentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = '__all__'
        # ê²°ê³¼: {"id": 1, "article": 1, "content": "...", ...}
        # article í•„ë“œê°€ IDë¡œë§Œ í‘œì‹œë¨
```

**GET - ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ**
```python
# articles/urls.py
from django.urls import path
from . import views

app_name = 'articles'
urlpatterns = [
    path('articles/', views.article_list),
    path('articles/<int:article_pk>/', views.article_detail),
    path('comments/', views.comment_list),
    path('comments/<int:comment_pk>/', views.comment_detail),
    path('articles/<int:article_pk>/comments/', views.comment_create),
]
```
```python
# articles/views.py
from rest_framework.response import Response
from rest_framework.decorators import api_view
from rest_framework import status

from .models import Article, Comment
from .serializers import CommentSerializer

@api_view(['GET'])
def comment_list(request):
    # ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
    comments = Comment.objects.all()
    
    # ì§ë ¬í™” (many=True: ì—¬ëŸ¬ ê°ì²´)
    serializer = CommentSerializer(comments, many=True)
    
    # JSON ì‘ë‹µ ë°˜í™˜
    return Response(serializer.data)

# Postman í…ŒìŠ¤íŠ¸:
# GET http://127.0.0.1:8000/api/v1/comments/
# ì‘ë‹µ: [{"id": 1, "article": 1, "content": "..."}, ...]
```

**GET - ë‹¨ì¼ ëŒ“ê¸€ ì¡°íšŒ**
```python
# articles/views.py
@api_view(['GET'])
def comment_detail(request, comment_pk):
    # íŠ¹ì • ëŒ“ê¸€ ì¡°íšŒ
    comment = Comment.objects.get(pk=comment_pk)
    
    # ì§ë ¬í™”
    serializer = CommentSerializer(comment)
    
    # JSON ì‘ë‹µ ë°˜í™˜
    return Response(serializer.data)

# Postman í…ŒìŠ¤íŠ¸:
# GET http://127.0.0.1:8000/api/v1/comments/1/
# ì‘ë‹µ: {"id": 1, "article": 1, "content": "...", "created_at": "...", ...}
```

**POST - ëŒ“ê¸€ ìƒì„± (read_only_fields ì—†ì´ - ì—ëŸ¬ ë°œìƒ)**
```python
# articles/views.py
@api_view(['POST'])
def comment_create(request, article_pk):
    # ê²Œì‹œê¸€ ì¡°íšŒ
    article = Article.objects.get(pk=article_pk)
    
    # Serializer ìƒì„±
    serializer = CommentSerializer(data=request.data)
    
    # ìœ íš¨ì„± ê²€ì‚¬
    if serializer.is_valid(raise_exception=True):
        # save()ì— ì¶”ê°€ ë°ì´í„° ì „ë‹¬
        serializer.save(article=article)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

# Postman í…ŒìŠ¤íŠ¸:
# POST http://127.0.0.1:8000/api/v1/articles/1/comments/
# Body > form-data:
#   content: "ëŒ“ê¸€ ë‚´ìš©"
# âŒ ì‘ë‹µ: {"article": ["This field is required."]} (400 Bad Request)
# ì›ì¸: article í•„ë“œê°€ í•„ìˆ˜ì¸ë° ì „ë‹¬ë˜ì§€ ì•ŠìŒ
```

**read_only_fields ì ìš© - ëŒ“ê¸€ ìƒì„± ì„±ê³µ**
```python
# articles/serializers.py
class CommentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = '__all__'
        # article í•„ë“œë¥¼ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì§€ì •
        read_only_fields = ('article',)
        
# read_only_fieldsì˜ ì˜ë¯¸:
# 1. ìœ íš¨ì„± ê²€ì‚¬ì—ì„œ ì œì™¸ (í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚´ì§€ ì•Šì•„ë„ ë¨)
# 2. ì‘ë‹µì—ëŠ” í¬í•¨ë¨
# 3. viewì—ì„œ save(article=article)ë¡œ ê°’ ì„¤ì •
```
```python
# articles/views.py
@api_view(['POST'])
def comment_create(request, article_pk):
    article = Article.objects.get(pk=article_pk)
    serializer = CommentSerializer(data=request.data)
    
    if serializer.is_valid(raise_exception=True):
        # article í•„ë“œëŠ” read_onlyì´ë¯€ë¡œ save()ì—ì„œ ì „ë‹¬
        serializer.save(article=article)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

# Postman í…ŒìŠ¤íŠ¸:
# POST http://127.0.0.1:8000/api/v1/articles/1/comments/
# Body > form-data:
#   content: "ëŒ“ê¸€ ìƒì„±"
# âœ… ì‘ë‹µ: {"id": 21, "content": "ëŒ“ê¸€ ìƒì„±", ..., "article": 1} (201 Created)
```

**PUT & DELETE - ëŒ“ê¸€ ìˆ˜ì • ë° ì‚­ì œ**
```python
# articles/views.py
@api_view(['GET', 'PUT', 'DELETE'])
def comment_detail(request, comment_pk):
    comment = Comment.objects.get(pk=comment_pk)
    
    if request.method == 'GET':
        serializer = CommentSerializer(comment)
        return Response(serializer.data)
    
    elif request.method == 'PUT':
        # ì „ì²´ ìˆ˜ì •
        serializer = CommentSerializer(comment, data=request.data)
        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response(serializer.data)
    
    elif request.method == 'DELETE':
        # ì‚­ì œ
        comment.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)

# Postman í…ŒìŠ¤íŠ¸:
# PUT http://127.0.0.1:8000/api/v1/comments/1/
# Body > form-data:
#   content: "ìˆ˜ì •ëœ ëŒ“ê¸€"
# ì‘ë‹µ: {"id": 1, "content": "ìˆ˜ì •ëœ ëŒ“ê¸€", ...} (200 OK)

# DELETE http://127.0.0.1:8000/api/v1/comments/1/
# ì‘ë‹µ: (ë¹ˆ ë³¸ë¬¸, 204 No Content)
```

**ì¤‘ì²© Serializer - ëŒ“ê¸€ ì¡°íšŒ ì‹œ ê²Œì‹œê¸€ ì œëª© í¬í•¨**
```python
# articles/serializers.py
class CommentSerializer(serializers.ModelSerializer):
    # ì¤‘ì²© Serializer ì •ì˜
    class ArticleTitleSerializer(serializers.ModelSerializer):
        class Meta:
            model = Article
            fields = ('title',)
    
    # article í•„ë“œë¥¼ ì¤‘ì²© Serializerë¡œ ì¬ì •ì˜
    article = ArticleTitleSerializer(read_only=True)
    
    class Meta:
        model = Comment
        fields = '__all__'
        # âš ï¸ ì£¼ì˜: í•„ë“œë¥¼ ì¬ì •ì˜í•˜ë©´ read_only_fields ë™ì‘ ì•ˆ í•¨
        # read_only_fields = ('article',)  # ì´ì œ í•„ìš” ì—†ìŒ
        # ëŒ€ì‹  article = ArticleTitleSerializer(read_only=True) ì‚¬ìš©

# GET http://127.0.0.1:8000/api/v1/comments/1/ ì‘ë‹µ:
# {
#     "id": 1,
#     "article": {
#         "title": "ê²Œì‹œê¸€ ì œëª©"
#     },
#     "content": "ëŒ“ê¸€ ë‚´ìš©",
#     "created_at": "...",
#     "updated_at": "..."
# }
```

**ì—­ì°¸ì¡° - ê²Œì‹œê¸€ ì¡°íšŒ ì‹œ ëŒ“ê¸€ ëª©ë¡ í¬í•¨**
```python
# articles/serializers.py
class ArticleSerializer(serializers.ModelSerializer):
    # ì¤‘ì²© Serializer ì •ì˜
    class CommentDetailSerializer(serializers.ModelSerializer):
        class Meta:
            model = Comment
            fields = ('id', 'content', 'created_at',)
    
    # ì—­ì°¸ì¡°ë¡œ ëŒ“ê¸€ ëª©ë¡ í¬í•¨ (many=True: ì—¬ëŸ¬ ëŒ“ê¸€)
    comment_set = CommentDetailSerializer(many=True, read_only=True)
    
    class Meta:
        model = Article
        fields = '__all__'

# GET http://127.0.0.1:8000/api/v1/articles/1/ ì‘ë‹µ:
# {
#     "id": 1,
#     "title": "ê²Œì‹œê¸€ ì œëª©",
#     "content": "ê²Œì‹œê¸€ ë‚´ìš©",
#     "comment_set": [
#         {"id": 1, "content": "ëŒ“ê¸€1", "created_at": "..."},
#         {"id": 2, "content": "ëŒ“ê¸€2", "created_at": "..."}
#     ],
#     "created_at": "...",
#     "updated_at": "..."
# }
```

**annotateì™€ Count - ëŒ“ê¸€ ê°œìˆ˜ ì§‘ê³„**
```python
# articles/views.py
from django.db.models import Count

@api_view(['GET', 'PUT', 'DELETE'])
def article_detail(request, article_pk):
    # annotateë¡œ ëŒ“ê¸€ ê°œìˆ˜ í•„ë“œ ì¶”ê°€
    article = Article.objects.annotate(
        num_of_comments=Count('comment')
    ).get(pk=article_pk)
    
    if request.method == 'GET':
        serializer = ArticleSerializer(article)
        return Response(serializer.data)
    
    # PUT, DELETE ë¡œì§...

# âš ï¸ ì£¼ì˜: annotateë¡œ ì¶”ê°€í•œ í•„ë“œëŠ” ëª¨ë¸ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
# Serializerì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ SerializerMethodField í•„ìš”
```

**SerializerMethodField - ëŒ“ê¸€ ê°œìˆ˜ ì‘ë‹µì— í¬í•¨**
```python
# articles/serializers.py
from django.db.models import Count

class ArticleSerializer(serializers.ModelSerializer):
    # SerializerMethodField ì •ì˜
    num_of_comments = serializers.SerializerMethodField()
    
    class Meta:
        model = Article
        fields = '__all__'
    
    # get_<í•„ë“œëª…> ë©”ì„œë“œ ì •ì˜ (í•„ìˆ˜)
    def get_num_of_comments(self, obj):
        # objëŠ” Article ì¸ìŠ¤í„´ìŠ¤
        # viewì—ì„œ annotateí•œ í•„ë“œ ì‚¬ìš©
        return obj.num_of_comments

# GET http://127.0.0.1:8000/api/v1/articles/3/ ì‘ë‹µ:
# {
#     "id": 3,
#     "title": "ê²Œì‹œê¸€ ì œëª©",
#     "content": "ê²Œì‹œê¸€ ë‚´ìš©",
#     "num_of_comments": 2,  # â† SerializerMethodField
#     "created_at": "...",
#     "updated_at": "..."
# }
```

**SerializerMethodField í™œìš© ì˜ˆì‹œ**
```python
# articles/serializers.py
class ArticleSerializer(serializers.ModelSerializer):
    # ëŒ“ê¸€ ê°œìˆ˜
    num_of_comments = serializers.SerializerMethodField()
    # ì‘ì„±ì ì „ì²´ ì´ë¦„
    author_full_name = serializers.SerializerMethodField()
    # ëŒ“ê¸€ ìˆëŠ”ì§€ ì—¬ë¶€
    has_comments = serializers.SerializerMethodField()
    
    class Meta:
        model = Article
        fields = '__all__'
    
    def get_num_of_comments(self, obj):
        return obj.comment_set.count()
    
    def get_author_full_name(self, obj):
        return f"{obj.user.first_name} {obj.user.last_name}"
    
    def get_has_comments(self, obj):
        return obj.comment_set.exists()

# ì‘ë‹µ:
# {
#     "id": 1,
#     "num_of_comments": 5,
#     "author_full_name": "John Doe",
#     "has_comments": true,
#     ...
# }
```

**get_object_or_404 ì‚¬ìš© - ëª…í™•í•œ 404 ì‘ë‹µ**
```python
# articles/views.py
from django.shortcuts import get_object_or_404

# âŒ ì˜ëª»ëœ ë°©ë²• (500 ì—ëŸ¬ ë°œìƒ)
@api_view(['GET'])
def article_detail(request, article_pk):
    article = Article.objects.get(pk=article_pk)  # ì—†ìœ¼ë©´ DoesNotExist ì˜ˆì™¸
    serializer = ArticleSerializer(article)
    return Response(serializer.data)
# ë¬¸ì œ: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” PK ìš”ì²­ ì‹œ 500 Server Error ë°œìƒ
# í´ë¼ì´ì–¸íŠ¸ëŠ” ì„œë²„ ë¬¸ì œë¡œ ì˜¤í•´

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (404 ì‘ë‹µ)
@api_view(['GET'])
def article_detail(request, article_pk):
    article = get_object_or_404(Article, pk=article_pk)  # ì—†ìœ¼ë©´ Http404
    serializer = ArticleSerializer(article)
    return Response(serializer.data)
# ì¥ì : ì¡´ì¬í•˜ì§€ ì•ŠëŠ” PK ìš”ì²­ ì‹œ 404 Not Found ì‘ë‹µ
# í´ë¼ì´ì–¸íŠ¸ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŒì„ ëª…í™•íˆ ì¸ì‹

# annotateì™€ í•¨ê»˜ ì‚¬ìš©
@api_view(['GET', 'PUT', 'DELETE'])
def article_detail(request, article_pk):
    article = get_object_or_404(
        Article.objects.annotate(num_of_comments=Count('comment')),
        pk=article_pk
    )
    # ...
```

**get_list_or_404 ì‚¬ìš© - ë¹ˆ ë¦¬ìŠ¤íŠ¸ ëŒ€ì‹  404 ì‘ë‹µ**
```python
# articles/views.py
from django.shortcuts import get_list_or_404

# âŒ ì˜ëª»ëœ ë°©ë²• (ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜)
@api_view(['GET'])
def comment_list(request):
    comments = Comment.objects.all()  # ì—†ìœ¼ë©´ ë¹ˆ QuerySet
    serializer = CommentSerializer(comments, many=True)
    return Response(serializer.data)
# ë¬¸ì œ: ëŒ“ê¸€ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ [] ë°˜í™˜ (200 OK)
# í´ë¼ì´ì–¸íŠ¸ëŠ” ë°ì´í„°ê°€ ì—†ëŠ”ì§€, ìš”ì²­ì´ ì˜ëª»ëëŠ”ì§€ ëª¨ë¦„

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (404 ì‘ë‹µ)
@api_view(['GET'])
def comment_list(request):
    comments = get_list_or_404(Comment)  # ì—†ìœ¼ë©´ Http404
    serializer = CommentSerializer(comments, many=True)
    return Response(serializer.data)
# ì¥ì : ëŒ“ê¸€ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ 404 Not Found ì‘ë‹µ
# í´ë¼ì´ì–¸íŠ¸ëŠ” ë¦¬ì†ŒìŠ¤ê°€ ì—†ìŒì„ ëª…í™•íˆ ì¸ì‹

# í•„í„°ì™€ í•¨ê»˜ ì‚¬ìš©
@api_view(['GET'])
def article_comments(request, article_pk):
    article = get_object_or_404(Article, pk=article_pk)
    comments = get_list_or_404(Comment, article=article)
    serializer = CommentSerializer(comments, many=True)
    return Response(serializer.data)
```

**ì—­ì°¸ì¡° ë§¤ë‹ˆì €ëª… ë³€ê²½ ì‹œ ì£¼ì˜ì‚¬í•­**
```python
# articles/models.py
class Comment(models.Model):
    # related_nameìœ¼ë¡œ ì—­ì°¸ì¡° ë§¤ë‹ˆì €ëª… ë³€ê²½
    article = models.ForeignKey(
        Article, 
        on_delete=models.CASCADE, 
        related_name='comments'  # comment_set â†’ comments
    )
    content = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```
```python
# articles/serializers.py
class ArticleSerializer(serializers.ModelSerializer):
    class CommentDetailSerializer(serializers.ModelSerializer):
        class Meta:
            model = Comment
            fields = ('id', 'content',)
    
    # related_name ë³€ê²½í–ˆìœ¼ë¯€ë¡œ í•„ë“œëª…ë„ ë³€ê²½
    comments = CommentDetailSerializer(many=True, read_only=True)
    # âŒ comment_set = CommentDetailSerializer(many=True, read_only=True)
    
    class Meta:
        model = Article
        fields = '__all__'
```
```python
# articles/views.py
from django.db.models import Count

@api_view(['GET'])
def article_detail(request, article_pk):
    # annotateì—ì„œë„ ë³€ê²½ëœ ì´ë¦„ ì‚¬ìš©
    article = get_object_or_404(
        Article.objects.annotate(num_of_comments=Count('comments')),
        pk=article_pk
    )
    # âŒ Count('comment')
    serializer = ArticleSerializer(article)
    return Response(serializer.data)
```

**read_only ì¸ì vs read_only_fields**
```python
# articles/serializers.py

# Case 1: read_only_fields ì‚¬ìš© (í•„ë“œë¥¼ ì¬ì •ì˜í•˜ì§€ ì•Šì€ ê²½ìš°)
class CommentSerializer(serializers.ModelSerializer):
    class Meta:
        model = Comment
        fields = '__all__'
        read_only_fields = ('article',)  # âœ… ë™ì‘í•¨

# Case 2: í•„ë“œë¥¼ ì¬ì •ì˜í•œ ê²½ìš° (read_only_fields ë™ì‘ ì•ˆ í•¨)
class CommentSerializer(serializers.ModelSerializer):
    class ArticleTitleSerializer(serializers.ModelSerializer):
        class Meta:
            model = Article
            fields = ('title',)
    
    # í•„ë“œë¥¼ ì¬ì •ì˜í–ˆìœ¼ë¯€ë¡œ read_only ì¸ì ì‚¬ìš©
    article = ArticleTitleSerializer(read_only=True)
    
    class Meta:
        model = Comment
        fields = '__all__'
        # âŒ read_only_fields = ('article',)  # ë™ì‘ ì•ˆ í•¨!

# ê·œì¹™:
# - í•„ë“œë¥¼ ì¬ì •ì˜ ë˜ëŠ” ì¶”ê°€í•œ ê²½ìš° â†’ read_only ì¸ì ì‚¬ìš©
# - ëª¨ë¸ í•„ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ëŠ” ê²½ìš° â†’ read_only_fields ì‚¬ìš©
```

**API ë¬¸ì„œí™” - drf-spectacular ì„¤ì¹˜ ë° ì„¤ì •**
```bash
# ì„¤ì¹˜
$ pip install drf-spectacular
```
```python
# settings.py
INSTALLED_APPS = [
    # ...
    'rest_framework',
    'drf_spectacular',  # ì¶”ê°€
]

# OpenAPI êµ¬ì¡° ìë™ ìƒì„± ì„¤ì •
REST_FRAMEWORK = {
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}
```
```python
# drf/urls.py (í”„ë¡œì íŠ¸ urls.py)
from django.contrib import admin
from django.urls import path, include
from drf_spectacular.views import (
    SpectacularAPIView,
    SpectacularRedocView,
    SpectacularSwaggerView,
)

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/v1/', include('articles.urls')),
    
    # API ìŠ¤í‚¤ë§ˆ
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    
    # Swagger UI
    path('api/schema/swagger-ui/', 
         SpectacularSwaggerView.as_view(url_name='schema'), 
         name='swagger-ui'),
    
    # ReDoc
    path('api/schema/redoc/', 
         SpectacularRedocView.as_view(url_name='schema'), 
         name='redoc'),
]

# ì ‘ì†:
# Swagger UI: http://127.0.0.1:8000/api/schema/swagger-ui/
# ReDoc: http://127.0.0.1:8000/api/schema/redoc/
```

**ì™„ì „í•œ Comment CRUD View í•¨ìˆ˜**
```python
# articles/views.py
from rest_framework.response import Response
from rest_framework.decorators import api_view
from rest_framework import status
from django.shortcuts import get_object_or_404, get_list_or_404
from django.db.models import Count

from .models import Article, Comment
from .serializers import (
    ArticleListSerializer,
    ArticleSerializer,
    CommentSerializer,
)

# ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ
@api_view(['GET'])
def comment_list(request):
    comments = get_list_or_404(Comment)
    serializer = CommentSerializer(comments, many=True)
    return Response(serializer.data)

# ëŒ“ê¸€ ìƒì„¸ ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œ
@api_view(['GET', 'PUT', 'DELETE'])
def comment_detail(request, comment_pk):
    comment = get_object_or_404(Comment, pk=comment_pk)
    
    if request.method == 'GET':
        serializer = CommentSerializer(comment)
        return Response(serializer.data)
    
    elif request.method == 'PUT':
        serializer = CommentSerializer(comment, data=request.data)
        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response(serializer.data)
    
    elif request.method == 'DELETE':
        comment.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)

# ëŒ“ê¸€ ìƒì„±
@api_view(['POST'])
def comment_create(request, article_pk):
    article = get_object_or_404(Article, pk=article_pk)
    serializer = CommentSerializer(data=request.data)
    
    if serializer.is_valid(raise_exception=True):
        # article í•„ë“œëŠ” read_onlyì´ë¯€ë¡œ save()ì—ì„œ ì „ë‹¬
        serializer.save(article=article)
        return Response(serializer.data, status=status.HTTP_201_CREATED)

# ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ (ëŒ“ê¸€ ê°œìˆ˜ í¬í•¨)
@api_view(['GET', 'PUT', 'DELETE'])
def article_detail(request, article_pk):
    # annotateë¡œ ëŒ“ê¸€ ê°œìˆ˜ ì¶”ê°€
    article = get_object_or_404(
        Article.objects.annotate(num_of_comments=Count('comment')),
        pk=article_pk
    )
    
    if request.method == 'GET':
        serializer = ArticleSerializer(article)
        return Response(serializer.data)
    
    elif request.method == 'PUT':
        serializer = ArticleSerializer(article, data=request.data)
        if serializer.is_valid(raise_exception=True):
            serializer.save()
            return Response(serializer.data)
    
    elif request.method == 'DELETE':
        article.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)
```

# ğŸ› ï¸ ì´ìŠˆ & í•´ê²°
| ğŸ ë¬¸ì œ ìƒí™© | ğŸ” ì›ì¸ | ğŸ’¡ í•´ê²° ë°©ë²• |
|--------------|--------|--------------|
| ëŒ“ê¸€ ìƒì„± ì‹œ "article field is required" 400 ì—ëŸ¬ ë°œìƒ | article í•„ë“œê°€ í•„ìˆ˜ì¸ë° í´ë¼ì´ì–¸íŠ¸ê°€ ì „ì†¡í•˜ì§€ ì•ŠìŒ | CommentSerializerì˜ Metaì— `read_only_fields = ('article',)` ì¶”ê°€, viewì—ì„œ `save(article=article)` ì‚¬ìš© |
| read_only_fields ì„¤ì •í–ˆëŠ”ë° ë™ì‘í•˜ì§€ ì•ŠìŒ | í•„ë“œë¥¼ ì¤‘ì²© Serializerë¡œ ì¬ì •ì˜í•˜ë©´ read_only_fields ë¬´ì‹œë¨ | ì¬ì •ì˜í•œ í•„ë“œì— `read_only=True` ì¸ì ì§ì ‘ ì§€ì • |
| annotateë¡œ ì¶”ê°€í•œ í•„ë“œê°€ Serializerì—ì„œ ì¸ì‹ë˜ì§€ ì•ŠìŒ | annotate í•„ë“œëŠ” ëª¨ë¸ì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ì§€ ì•ŠìŒ | SerializerMethodField ì‚¬ìš©í•˜ê³  get_<í•„ë“œëª…> ë©”ì„œë“œ ì •ì˜ |
| SerializerMethodField ì •ì˜í–ˆëŠ”ë° ê°’ì´ í‘œì‹œë˜ì§€ ì•ŠìŒ | get_<í•„ë“œëª…> ë©”ì„œë“œë¥¼ ì •ì˜í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ë¦„ì´ í‹€ë¦¼ | `get_num_of_comments(self, obj)` í˜•ì‹ìœ¼ë¡œ ë©”ì„œë“œ ì •ì˜ í™•ì¸ |
| ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ ìš”ì²­ ì‹œ 500 Server Error ë°œìƒ | ì¼ë°˜ get() ì‚¬ìš© ì‹œ DoesNotExist ì˜ˆì™¸ê°€ 500 ì—ëŸ¬ë¡œ ì²˜ë¦¬ë¨ | `get_object_or_404(Article, pk=article_pk)` ì‚¬ìš©í•˜ì—¬ 404 ì‘ë‹µ |
| ëŒ“ê¸€ì´ ì—†ì„ ë•Œ ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜, ë¦¬ì†ŒìŠ¤ ë¶€ì¬ ëª…í™•í•˜ì§€ ì•ŠìŒ | all() ë˜ëŠ” filter() ì‚¬ìš© ì‹œ ë¹ˆ QuerySetì€ 200 OKë¡œ ë°˜í™˜ | `get_list_or_404(Comment)` ì‚¬ìš©í•˜ì—¬ 404 ì‘ë‹µ |
| related_name ë³€ê²½ í›„ comment_setìœ¼ë¡œ ì ‘ê·¼í•˜ë ¤ë‹ˆ AttributeError | related_nameì„ 'comments'ë¡œ ë³€ê²½í•˜ë©´ ê¸°ë³¸ ì´ë¦„ ì‚¬ë¼ì§ | Serializerì™€ annotateì—ì„œ ëª¨ë‘ 'comments' ì‚¬ìš© |
| Swagger UIì—ì„œ APIê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ | drf-spectacular ì„¤ì • ëˆ„ë½ ë˜ëŠ” URL ë“±ë¡ ì•ˆ ë¨ | settings.pyì— DEFAULT_SCHEMA_CLASS ì„¤ì •, urls.pyì— Swagger URL ì¶”ê°€ í™•ì¸ |
| POST ìš”ì²­ ì‹œ ì¤‘ì²© Serializerê°€ ì…ë ¥ì„ ë°›ì•„ë²„ë¦¼ | read_only=True ì„¤ì •í•˜ì§€ ì•ŠìŒ | ì¤‘ì²© Serializerì— `read_only=True` ë°˜ë“œì‹œ ì¶”ê°€ |