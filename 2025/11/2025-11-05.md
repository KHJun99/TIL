# 2025-11-05 TIL

# âœ… ì˜¤ëŠ˜ í•œ ì¼
- Django N:1 ê´€ê³„(Many to One Relationships) ê°œë… í•™ìŠµ
- Comment ëª¨ë¸ì— ForeignKey ì ìš©í•˜ì—¬ ëŒ“ê¸€ ëª¨ë¸ ì •ì˜
- Django shellì—ì„œ ORMì„ í™œìš©í•œ ëŒ“ê¸€ ìƒì„± ì—°ìŠµ
- ì°¸ì¡°ì™€ ì—­ì°¸ì¡°ì˜ ì°¨ì´ì  ì´í•´ ë° í™œìš©
- ëŒ“ê¸€ CRUD ê¸°ëŠ¥ êµ¬í˜„ (CREATE, READ, DELETE)
- save(commit=False) ë©”ì„œë“œë¥¼ í™œìš©í•œ ì™¸ë˜ í‚¤ ë°ì´í„° ì²˜ë¦¬
- for-empty íƒœê·¸ë¡œ ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš° ëŒ€ì²´ ì½˜í…ì¸  ì¶œë ¥
- ì—­ì°¸ì¡°ë¥¼ ì´ìš©í•œ ëŒ“ê¸€ ê°œìˆ˜ ì¶œë ¥ êµ¬í˜„

# ğŸ“š ë°°ìš´ ì 
- **N:1 ê´€ê³„ì˜ ì˜ë¯¸**: ì—¬ëŸ¬ ê°œì˜ ë ˆì½”ë“œ(ëŒ“ê¸€)ê°€ í•˜ë‚˜ì˜ ë ˆì½”ë“œ(ê²Œì‹œê¸€)ì™€ ì—°ê²°ë˜ëŠ” ê´€ê³„
- **ForeignKey í•„ë“œ**: N:1 ê´€ê³„ í‘œí˜„ ì‹œ ì‚¬ìš©í•˜ë©°, ë‹¨ìˆ˜í˜•ìœ¼ë¡œ ì‘ì„±í•˜ëŠ” ê²ƒì´ ê¶Œì¥ë¨
- **on_delete ì†ì„±ì˜ ì¤‘ìš”ì„±**: ë¶€ëª¨ ê°ì²´ ì‚­ì œ ì‹œ ìì‹ ê°ì²´ ì²˜ë¦¬ ë°©ë²• ì •ì˜ (CASCADE, PROTECT, SET_NULL)
- **ì°¸ì¡° vs ì—­ì°¸ì¡°**: ì°¸ì¡°ëŠ” `comment.article`, ì—­ì°¸ì¡°ëŠ” `article.comment_set.all()`
- **Related Manager**: Djangoê°€ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ì—­ì°¸ì¡° ì´ë¦„ (ëª¨ë¸ëª…_set)
- **save(commit=False)**: DB ì €ì¥ ì—†ì´ ì¸ìŠ¤í„´ìŠ¤ë§Œ ìƒì„±í•˜ì—¬ ì¶”ê°€ ë°ì´í„°ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŒ
- **Variable Routing**: URLì—ì„œ ì—¬ëŸ¬ ê°œì˜ pk ê°’ì„ ì „ë‹¬ë°›ì•„ ì²˜ë¦¬ ê°€ëŠ¥
- **ë°ì´í„° ë¬´ê²°ì„±**: ForeignKeyì™€ on_deleteë¡œ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€

# ğŸ“Œ í•µì‹¬ ê°œë…
- **ForeignKey(to, on_delete)**: N:1 ê´€ê³„ ì„¤ì • í•„ë“œ, ì°¸ì¡° ëª¨ë¸ê³¼ ì‚­ì œ ì •ì±… í•„ìˆ˜ ì§€ì •
- **on_delete ì˜µì…˜**:
  - CASCADE: ë¶€ëª¨ ì‚­ì œ ì‹œ ìì‹ë„ í•¨ê»˜ ì‚­ì œ
  - PROTECT: ìì‹ì´ ìˆìœ¼ë©´ ë¶€ëª¨ ì‚­ì œ ë¶ˆê°€
  - SET_NULL: ë¶€ëª¨ ì‚­ì œ ì‹œ ìì‹ì˜ ì™¸ë˜ í‚¤ë¥¼ NULLë¡œ ì„¤ì •
- **Related Manager (ì—­ì°¸ì¡°)**: `article.comment_set.all()` - ê²Œì‹œê¸€ì—ì„œ ëŒ“ê¸€ ì¡°íšŒ
- **save(commit=False)**: ì¸ìŠ¤í„´ìŠ¤ ìƒì„± í›„ DB ì €ì¥ ì „ ì¶”ê°€ ì‘ì—… ê°€ëŠ¥
- **for-empty íƒœê·¸**: ë°ì´í„°ê°€ ì—†ì„ ë•Œ ëŒ€ì²´ ì½˜í…ì¸  ì¶œë ¥
- **ëŒ“ê¸€ ê°œìˆ˜ ì¶œë ¥**: `{{ comments|length }}`, `{{ article.comment_set.count }}` (count ê¶Œì¥)
- **ì™¸ë˜ í‚¤ í•„ë“œëª…**: ëª¨ë¸ì—ì„œ `article`ë¡œ ì •ì˜í•´ë„ DBì—ëŠ” `article_id`ë¡œ ì €ì¥ë¨
- **CommentFormì˜ fields**: ì™¸ë˜ í‚¤ í•„ë“œ(article)ëŠ” ì œì™¸í•˜ê³  ì‚¬ìš©ì ì…ë ¥ í•„ë“œë§Œ í¬í•¨

# ğŸ’¡ ì˜ˆì‹œ ì½”ë“œ

**Comment ëª¨ë¸ ì •ì˜ - ForeignKey ì‚¬ìš©**
```python
# articles/models.py
from django.db import models

class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

class Comment(models.Model):
    # ForeignKeyë¡œ N:1 ê´€ê³„ ì„¤ì •
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    content = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

# ë§ˆì´ê·¸ë ˆì´ì…˜ í›„ DBì—ëŠ” article_id í•„ë“œë¡œ ìƒì„±ë¨
```

**Django shellì—ì„œ ëŒ“ê¸€ ìƒì„± ì—°ìŠµ**
```python
# Django shell ì‹¤í–‰
$ python manage.py shell

# ê²Œì‹œê¸€ ìƒì„±
from articles.models import Article, Comment
Article.objects.create(title='title', content='content')

# ëŒ“ê¸€ ìƒì„± (1) - ë‹¨ê³„ë³„ ë°©ì‹
comment = Comment()
comment.content = 'first comment'

# ê²Œì‹œê¸€ ì •ë³´ ê°€ì ¸ì™€ì„œ ì™¸ë˜ í‚¤ ì„¤ì •
article = Article.objects.get(pk=1)
comment.article = article  # ì¶”ì²œ ë°©ì‹
# comment.article_id = article.pk  # ë¹„ê¶Œì¥ (ì§ì ‘ í…Œì´ë¸” í•„ë“œ ì ‘ê·¼)

comment.save()

# ëŒ“ê¸€ ìƒì„± (2) - í•œ ë²ˆì— ìƒì„±
commentary = Comment(content='second comment', article=article)
commentary.save()

# ëŒ“ê¸€ì„ í†µí•œ ê²Œì‹œê¸€ ì°¸ì¡°
comment.article  # <Article: Article object (1)>
comment.article_id  # 1
comment.article.pk  # 1
comment.article.content  # 'content'
```

**CommentForm ì •ì˜**
```python
# articles/forms.py
from django import forms
from .models import Article, Comment

class CommentForm(forms.ModelForm):
    class Meta:
        model = Comment
        # article í•„ë“œëŠ” ì œì™¸ (ì‚¬ìš©ì ì…ë ¥ì´ ì•„ë‹Œ viewì—ì„œ ì²˜ë¦¬)
        fields = ('content',)  # tuple ìš”ì†Œê°€ í•˜ë‚˜ì¼ ë•Œ ì½¤ë§ˆ(,) í•„ìˆ˜!
```

**ëŒ“ê¸€ CREATE - detail viewì™€ í…œí”Œë¦¿**
```python
# articles/views.py
from django.shortcuts import render, redirect
from .models import Article, Comment
from .forms import CommentForm

def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()
    # ì—­ì°¸ì¡°ë¡œ íŠ¹ì • ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ë§Œ ì¡°íšŒ
    comments = article.comment_set.all()
    
    context = {
        'article': article,
        'comment_form': comment_form,
        'comments': comments,
    }
    return render(request, 'articles/detail.html', context)
```
```html
<!-- articles/detail.html -->
<h1>{{ article.title }}</h1>
<p>{{ article.content }}</p>

<!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
<form action="{% url 'articles:comments_create' article.pk %}" method="POST">
    {% csrf_token %}
    {{ comment_form }}
    <input type="submit" value="ëŒ“ê¸€ ì‘ì„±">
</form>

<!-- ëŒ“ê¸€ ëª©ë¡ ì¶œë ¥ -->
<h4>ëŒ“ê¸€ ëª©ë¡</h4>
<p>ëŒ“ê¸€ ê°œìˆ˜: {{ article.comment_set.count }}</p>  <!-- ë°©ë²• 3: count() ê¶Œì¥ -->
<!-- <p>ëŒ“ê¸€ ê°œìˆ˜: {{ comments|length }}</p> -->  <!-- ë°©ë²• 1: length í•„í„° -->
<!-- <p>ëŒ“ê¸€ ê°œìˆ˜: {{ article.comment_set.all|length }}</p> -->  <!-- ë°©ë²• 2 -->

<ul>
    {% for comment in comments %}
        <li>
            {{ comment.content }}
            <form action="{% url 'articles:comments_delete' article.pk comment.pk %}" method="POST">
                {% csrf_token %}
                <input type="submit" value="DELETE">
            </form>
        </li>
    {% empty %}
        <p>ëŒ“ê¸€ì´ ì—†ì–´ìš”..</p>
    {% endfor %}
</ul>
```

**ëŒ“ê¸€ CREATE - save(commit=False) í™œìš©**
```python
# articles/urls.py
from django.urls import path
from . import views

app_name = 'articles'
urlpatterns = [
    path('<int:pk>/', views.detail, name='detail'),
    path('<int:pk>/comments/', views.comments_create, name='comments_create'),
    path('<int:article_pk>/comments/<int:comment_pk>/delete/', 
         views.comments_delete, 
         name='comments_delete'),
]
```
```python
# articles/views.py
def comments_create(request, pk):
    # Variable Routingìœ¼ë¡œ ì „ë‹¬ëœ ê²Œì‹œê¸€ pkë¡œ ê²Œì‹œê¸€ ì¡°íšŒ
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm(request.POST)

    if comment_form.is_valid():
        # commit=False: DB ì €ì¥ ì—†ì´ ì¸ìŠ¤í„´ìŠ¤ë§Œ ë°˜í™˜
        comment = comment_form.save(commit=False)
        # ì™¸ë˜ í‚¤ ì •ë³´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€
        comment.article = article
        # ì´ì œ DBì— ì €ì¥
        comment.save()
        return redirect('articles:detail', article.pk)

    # ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì •ë³´ì™€ í•¨ê»˜ ë‹¤ì‹œ ë Œë”ë§
    context = {
        'article': article,
        'comment_form': comment_form,
    }
    return render(request, 'articles/detail.html', context)
```

**ëŒ“ê¸€ READ - ì—­ì°¸ì¡° í™œìš©**
```python
# articles/views.py
def detail(request, pk):
    article = Article.objects.get(pk=pk)
    comment_form = CommentForm()

    # âŒ ì˜ëª»ëœ ë°©ë²•: ëª¨ë“  ëŒ“ê¸€ ì¡°íšŒ
    # comments = Comment.objects.all()

    # âœ… ì˜¬ë°”ë¥¸ ë°©ë²•: ì—­ì°¸ì¡°ë¡œ íŠ¹ì • ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ë§Œ ì¡°íšŒ
    comments = article.comment_set.all()

    context = {
        'article': article,
        'comment_form': comment_form,
        'comments': comments,
    }
    return render(request, 'articles/detail.html', context)
```

**ëŒ“ê¸€ DELETE**
```python
# articles/views.py
def comments_delete(request, article_pk, comment_pk):
    # ì‚­ì œí•  ëŒ“ê¸€ ì¡°íšŒ
    comment = Comment.objects.get(pk=comment_pk)
    # ëŒ“ê¸€ ì‚­ì œ
    comment.delete()
    # ëŒ“ê¸€ì´ ì†í•œ ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return redirect('articles:detail', article_pk)
```

**ì°¸ì¡° vs ì—­ì°¸ì¡° ë¹„êµ**
```python
# ì°¸ì¡° (Comment â†’ Article)
# ëŒ“ê¸€ì—ì„œ ê²Œì‹œê¸€ë¡œ ì ‘ê·¼
comment = Comment.objects.get(pk=1)
comment.article  # ForeignKey í•„ë“œë¡œ ì§ì ‘ ì ‘ê·¼
comment.article.title  # ê²Œì‹œê¸€ì˜ ì œëª©
comment.article.content  # ê²Œì‹œê¸€ì˜ ë‚´ìš©

# ì—­ì°¸ì¡° (Article â†’ Comment)
# ê²Œì‹œê¸€ì—ì„œ ëŒ“ê¸€ë¡œ ì ‘ê·¼
article = Article.objects.get(pk=1)
article.comment_set.all()  # Related Manager ì‚¬ìš©
article.comment_set.count()  # ëŒ“ê¸€ ê°œìˆ˜
article.comment_set.filter(content__contains='hello')  # ëŒ“ê¸€ í•„í„°ë§
```

**on_delete ì˜µì…˜ ì˜ˆì‹œ**
```python
# articles/models.py

# CASCADE: ê²Œì‹œê¸€ ì‚­ì œ ì‹œ ëŒ“ê¸€ë„ í•¨ê»˜ ì‚­ì œ
class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    content = models.CharField(max_length=200)

# PROTECT: ëŒ“ê¸€ì´ ìˆìœ¼ë©´ ê²Œì‹œê¸€ ì‚­ì œ ë¶ˆê°€
class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.PROTECT)
    content = models.CharField(max_length=200)

# SET_NULL: ê²Œì‹œê¸€ ì‚­ì œ ì‹œ ëŒ“ê¸€ì˜ article í•„ë“œë¥¼ NULLë¡œ ì„¤ì •
class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.SET_NULL, null=True)
    content = models.CharField(max_length=200)
```

**admin ì‚¬ì´íŠ¸ ë“±ë¡**
```python
# articles/admin.py
from django.contrib import admin
from .models import Article, Comment

admin.site.register(Article)
admin.site.register(Comment)
```

**for-empty íƒœê·¸ í™œìš©**
```html
<!-- articles/detail.html -->
<h4>ëŒ“ê¸€ ëª©ë¡</h4>
<ul>
    {% for comment in comments %}
        <li>
            {{ comment.content }}
            <small>{{ comment.created_at }}</small>
        </li>
    {% empty %}
        <p>ëŒ“ê¸€ì´ ì—†ì–´ìš”..</p>
    {% endfor %}
</ul>
```

**ëŒ“ê¸€ ê°œìˆ˜ ì¶œë ¥ ë°©ë²• ë¹„êµ**
```html
<!-- ë°©ë²• 1: DTL filterì˜ length í™œìš© -->
<p>ëŒ“ê¸€ ê°œìˆ˜: {{ comments|length }}</p>

<!-- ë°©ë²• 2: ì—­ì°¸ì¡°ë¥¼ ì´ìš©í•˜ì—¬ ëŒ“ê¸€ ê¸¸ì´ í™•ì¸ -->
<p>ëŒ“ê¸€ ê°œìˆ˜: {{ article.comment_set.all|length }}</p>

<!-- ë°©ë²• 3: QuerySet APIì˜ count() ë©”ì„œë“œ í™œìš© (ê¶Œì¥) -->
<p>ëŒ“ê¸€ ê°œìˆ˜: {{ article.comment_set.count }}</p>
```

# ğŸ› ï¸ ì´ìŠˆ & í•´ê²°
| ğŸ ë¬¸ì œ ìƒí™© | ğŸ” ì›ì¸ | ğŸ’¡ í•´ê²° ë°©ë²• |
|--------------|--------|--------------|
| ëŒ“ê¸€ ìƒì„± ì‹œ `IntegrityError: NOT NULL constraint failed: articles_comment.article_id` ë°œìƒ | article_id í•„ë“œì— ê²Œì‹œê¸€ ì •ë³´ê°€ ì €ì¥ë˜ì§€ ì•ŠìŒ | `comment.article = article`ë¡œ ì™¸ë˜ í‚¤ ë°ì´í„°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì…ë ¥ í›„ ì €ì¥ |
| CommentFormì— article í•„ë“œê°€ í¬í•¨ë˜ì–´ ì‚¬ìš©ìê°€ ê²Œì‹œê¸€ì„ ì„ íƒí•  ìˆ˜ ìˆìŒ | fieldsì— ëª¨ë“  í•„ë“œë¥¼ í¬í•¨ì‹œí‚´ | `fields = ('content',)`ë¡œ article ì œì™¸, viewì—ì„œ save(commit=False)ë¡œ ì²˜ë¦¬ |
| ëŒ“ê¸€ ì €ì¥ ì‹œ ê²Œì‹œê¸€ ì •ë³´ë¥¼ í•¨ê»˜ ì €ì¥í•  ìˆ˜ ì—†ìŒ | save() í˜¸ì¶œ ì¦‰ì‹œ DBì— ì €ì¥ë˜ì–´ ì¶”ê°€ ì •ë³´ ì„¤ì • ë¶ˆê°€ | `save(commit=False)`ë¡œ ì¸ìŠ¤í„´ìŠ¤ë§Œ ìƒì„± â†’ article ì„¤ì • â†’ save() í˜¸ì¶œ |
| detail í˜ì´ì§€ì—ì„œ ëª¨ë“  ëŒ“ê¸€ì´ ì¡°íšŒë¨ | `Comment.objects.all()`ë¡œ ì „ì²´ ëŒ“ê¸€ ì¡°íšŒ | `article.comment_set.all()`ë¡œ ì—­ì°¸ì¡°í•˜ì—¬ íŠ¹ì • ê²Œì‹œê¸€ì˜ ëŒ“ê¸€ë§Œ ì¡°íšŒ |
| ëŒ“ê¸€ì´ ì—†ì„ ë•Œ ë¹ˆ ëª©ë¡ë§Œ í‘œì‹œë¨ | for ë¬¸ì´ ë¹ˆ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ | `{% for %}...{% empty %}` íƒœê·¸ë¡œ ëŒ€ì²´ ì½˜í…ì¸  ì¶œë ¥ |
| Variable Routingì—ì„œ ì—¬ëŸ¬ pkë¥¼ ì „ë‹¬í•  ë•Œ í˜¼ë™ | URL íŒ¨í„´ê³¼ view í•¨ìˆ˜ì˜ ë§¤ê°œë³€ìˆ˜ ì´ë¦„ì´ ë¶ˆëª…í™• | `article_pk`, `comment_pk`ì²˜ëŸ¼ ëª…í™•í•œ ë³€ìˆ˜ëª… ì‚¬ìš© |
| fieldsë¥¼ tupleë¡œ ì„¤ì • ì‹œ `fields = ('content')`ë¡œ ì‘ì„±í•˜ë©´ ì˜¤ë¥˜ | ìš”ì†Œê°€ í•˜ë‚˜ì¸ tupleì—ì„œ ì½¤ë§ˆ ëˆ„ë½ | `fields = ('content',)`ì²˜ëŸ¼ ë§ˆì§€ë§‰ì— ì½¤ë§ˆ(,) ë°˜ë“œì‹œ ì¶”ê°€ |