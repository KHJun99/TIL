# 2025-12-12 TIL

# ✅ 오늘 한 일
- JWT (JSON Web Token) 기반 인증 시스템 학습 및 구현
- djangorestframework-simplejwt 패키지를 사용한 JWT 인증 설정
- Access Token 및 Refresh Token 개념 이해 및 적용
- Geolocation API를 활용한 위치 기반 지도 검색 기능 구현
- diff 패키지를 활용한 텍스트 변경 감지 및 최적화

# 📚 배운 점
- **JWT의 구조와 동작 원리**: Header(알고리즘 정보), Payload(사용자 정보), Signature(위조 방지 서명)로 구성되며, 서버가 별도의 DB 조회 없이 토큰 검증만으로 인증을 처리하는 Stateless 방식임
- **Token 방식 vs JWT 방식**: Token 방식은 서버에 정보를 저장하여 보안성이 높지만 서버 부담이 크고, JWT는 서버 부담이 적고 확장성이 좋지만 키 유출 시 대응이 어려움
- **Refresh Token의 필요성**: Access Token의 짧은 유효기간 문제를 해결하기 위해 Refresh Token으로 Access Token을 재발급받아 사용자 편의성과 보안을 동시에 확보
- **Geolocation API**: `navigator.geolocation.getCurrentPosition()`을 통해 사용자의 현재 위치(위도, 경도)를 브라우저에서 간편하게 얻을 수 있음
- **iframe 활용**: YouTube, Google Maps, Google Calendar 등 외부 콘텐츠를 웹페이지에 삽입할 수 있으며, `src`, `width`, `height`, `allowfullscreen`, `loading` 속성으로 제어
- **diff 패키지**: 이전 텍스트와 새 텍스트의 차이를 구분하여 불필요한 API 요청을 줄이고 과금을 방지할 수 있음

# 📌 핵심 개념
- **JWT 인증 흐름**: 로그인 → JWT 발급 → 클라이언트 저장 → API 요청 시 Header에 담아 전송 → 서버에서 서명 검증 후 응답
- **Access Token 재발급 프로세스**: Access Token 만료 시(401 에러) → Refresh Token으로 재발급 요청 → 성공 시 새 Access Token으로 재요청, 실패 시 재로그인
- **Authorization Header 형식 변경**: Token 방식에서는 `Token <token>`, JWT 방식에서는 `Bearer <token>` 형식 사용
- **diffChars 메서드**: `diffChars(oldStr, newStr)`로 두 문자열을 비교하여 `added`, `removed`, `count` 속성을 가진 변경 객체 배열 반환
- **위치 기반 지도 최적화**: 사용자 입력마다 지도를 업데이트하는 대신 diff 패키지로 변경량을 판단하여 일정 threshold 이상일 때만 업데이트

# 💡 예시 코드

```javascript
// stores/accounts.js - JWT 로그인 및 Refresh Token 저장
const login = function ({ username, password }) {
  axios({
    method: 'post',
    url: `${API_URL}/accounts/login/`,
    data: { username, password },
  })
    .then((res) => {
      token.value = res.data.access    // Access Token 저장
      user.value = res.data.user       // 사용자 정보 저장
      refresh.value = res.data.refresh // Refresh Token 저장
      router.push({ name: 'ArticleView' })
    })
    .catch((err) => console.log(err))
}

// Access Token 재발급 함수
const refreshAccessToken = function () {
  return axios({
    method: 'post',
    url: `${API_URL}/accounts/token/refresh/`,
    data: { refresh: refresh.value },
  })
    .then((res) => {
      token.value = res.data.access  // Access Token 갱신
      return true
    })
    .catch((err) => {
      console.log(err)
      return false
    })
}
```

```javascript
// Geolocation API 활용
const lat = ref(null)
const lng = ref(null)
const error = ref('')

const loadLocation = () => {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      lat.value = pos.coords.latitude
      lng.value = pos.coords.longitude
    },
    (err) => error.value = err.message
  )
}
```

```javascript
// diff 패키지 활용 - 변경량 감지 후 지도 업데이트
import { diffChars } from 'diff'

const tryUpdateMap = () => {
  const changes = diffChars(prevKeyword.value, keyword.value)
  const diffCount = changes
    .filter(char => char.added || char.removed)
    .reduce((sum, char) => sum + char.count, 0)

  const threshold = 2 // 최소 2글자 이상 변경 시 업데이트
  if (diffCount >= threshold) {
    updateMap()
  } else {
    error.value = '키워드가 크게 바뀌지 않았습니다.'
  }
}
```

```python
# settings.py - JWT 설정
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
}

REST_AUTH = {
    'REGISTER_SERIALIZER': 'accounts.serializers.CustomRegisterSerializer',
    'USE_JWT': True,
    'JWT_AUTH_HTTPONLY': False,  # Refresh Token 응답에 포함
}
```

# 🛠️ 이슈 & 해결
| 🐞 문제 상황 | 🔍 원인 | 💡 해결 방법 |
|--------------|--------|--------------|
| 로그인 후 Refresh Token이 빈 값으로 전달됨 | `dj_rest_auth`의 `JWT_AUTH_HTTPONLY` 기본값이 True로 설정되어 있어 Refresh Token이 HTTP-only 쿠키로만 전달됨 | `settings.py`에서 `JWT_AUTH_HTTPONLY: False` 설정하여 응답 body에 Refresh Token 포함 |
| Authorization Header 형식 오류로 인증 실패 | Token 방식(`Token <token>`)과 JWT 방식(`Bearer <token>`)의 헤더 형식이 다름 | 모든 axios 요청의 Authorization 헤더를 `Bearer ${token}` 형식으로 변경 |
| Access Token 만료 시 401 에러 발생 | Access Token의 짧은 유효기간으로 인한 만료 | 401 에러 발생 시 Refresh Token으로 Access Token 재발급 후 원래 요청 재시도, 재발급 실패 시 로그아웃 처리 |
| 사용자 입력마다 지도 API 요청으로 과금 우려 | 키워드 변경 감지 시 즉시 지도 업데이트 | diff 패키지로 변경량(diffCount) 계산 후 threshold(2글자) 이상일 때만 업데이트 |