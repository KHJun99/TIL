# 2025-09-25 TIL

# ✅ 오늘 한 일
- Django **CRUD(READ/CREATE/UPDATE/DELETE)** 흐름을 실제 뷰·템플릿로 구현
- **HTTP 메서드(GET/POST)** 의미와 사용 원칙, **CSRF**와 **PRG(Post→Redirect→Get)** 학습
- 단일 글 조회(detail), 새 글 작성(new/create), 수정(edit/update), 삭제(delete) 전 과정을 연결

# 📚 배운 점
- **GET**은 조회(안전·캐시 가능), **POST**는 상태 변경(생성·수정·삭제, 캐시 X) — 의미에 맞게 사용.
- **CSRF 토큰**은 DB에 영향을 주는 요청(POST 등)에서 필수. 누락 시 403 Forbidden.
- **PRG 패턴**으로 새로고침 중복 제출 방지: POST 처리 후 **redirect**로 GET을 유도(보통 302).
- Django에서는 **파괴적 작업을 GET으로 하지 않는다** → 삭제/수정은 반드시 **POST** 폼으로 전송.

# 📌 핵심 개념
- **단일 조회(Detail)**: `get_object_or_404()`로 안전하게 가져와 렌더.
- **Create**: `request.method == 'POST'`에서만 생성 처리 → 성공 시 `redirect('articles:detail', pk=...)`.
- **Delete**: POST 폼으로 전송 + CSRF 토큰 → 성공 시 목록으로 redirect.
- **Update**: `edit`(GET)에서 기존 값 채워 렌더, `update`(POST)에서 저장 후 redirect.
- **입력 채우기 팁**: `input`은 `value` 속성, `textarea`는 **태그 사이**에 텍스트.

# 💡 예시 코드

```python
# articles/urls.py
from django.urls import path
from . import views

app_name = "articles"
urlpatterns = [
    path("", views.index, name="index"),
    path("<int:pk>/", views.detail, name="detail"),
    path("new/", views.new, name="new"),
    path("create/", views.create, name="create"),          # POST 전용
    path("<int:pk>/delete/", views.delete, name="delete"), # POST 전용
    path("<int:pk>/edit/", views.edit, name="edit"),
    path("<int:pk>/update/", views.update, name="update"), # POST 전용
]
```

```python
# articles/views.py
from django.shortcuts import render, redirect, get_object_or_404
from .models import Article

def index(request):
    articles = Article.objects.all().order_by("-id")
    return render(request, "articles/index.html", {"articles": articles})

def detail(request, pk):
    article = get_object_or_404(Article, pk=pk)
    return render(request, "articles/detail.html", {"article": article})

def new(request):
    return render(request, "articles/new.html")

def create(request):
    if request.method != "POST":
        return redirect("articles:new")
    title = request.POST.get("title", "").strip()
    content = request.POST.get("content", "").strip()
    article = Article.objects.create(title=title, content=content)
    # PRG: 생성 후 상세 페이지로 리다이렉트
    return redirect("articles:detail", pk=article.pk)

def delete(request, pk):
    article = get_object_or_404(Article, pk=pk)
    if request.method == "POST":
        article.delete()
        return redirect("articles:index")
    return redirect("articles:detail", pk=pk)

def edit(request, pk):
    article = get_object_or_404(Article, pk=pk)
    return render(request, "articles/edit.html", {"article": article})

def update(request, pk):
    article = get_object_or_404(Article, pk=pk)
    if request.method != "POST":
        return redirect("articles:edit", pk=pk)
    article.title = request.POST.get("title", article.title).strip()
    article.content = request.POST.get("content", article.content).strip()
    article.save(update_fields=["title", "content"])
    return redirect("articles:detail", pk=pk)
```

```html
<!-- templates/articles/index.html -->
{% extends "base.html" %}
{% block content %}
  <h1>Articles</h1>
  <p><a href="{% url 'articles:new' %}">새 글 작성</a></p>
  <ul>
    {% for a in articles %}
      <li>
        <a href="{% url 'articles:detail' a.pk %}">[{{ a.id }}] {{ a.title }}</a>
        <form action="{% url 'articles:delete' a.pk %}" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit">삭제</button>
        </form>
      </li>
    {% empty %}
      <li>게시글이 없습니다.</li>
    {% endfor %}
  </ul>
{% endblock %}
```

```html
<!-- templates/articles/detail.html -->
{% extends "base.html" %}
{% block content %}
  <h1>{{ article.title }}</h1>
  <p>{{ article.content|linebreaksbr }}</p>
  <p>
    <a href="{% url 'articles:edit' article.pk %}">수정</a> |
    <a href="{% url 'articles:index' %}">목록</a>
  </p>
  <form action="{% url 'articles:delete' article.pk %}" method="post">
    {% csrf_token %}
    <button type="submit">삭제</button>
  </form>
{% endblock %}
```

```html
<!-- templates/articles/new.html -->
{% extends "base.html" %}
{% block content %}
  <h1>새 글</h1>
  <form action="{% url 'articles:create' %}" method="post">
    {% csrf_token %}
    <div>
      <label>제목</label>
      <input type="text" name="title" required />
    </div>
    <div>
      <label>내용</label>
      <textarea name="content" rows="6" required></textarea>
    </div>
    <button type="submit">작성</button>
  </form>
{% endblock %}
```

```html
<!-- templates/articles/edit.html -->
{% extends "base.html" %}
{% block content %}
  <h1>수정: {{ article.title }}</h1>
  <form action="{% url 'articles:update' article.pk %}" method="post">
    {% csrf_token %}
    <div>
      <label>제목</label>
      <input type="text" name="title" value="{{ article.title }}" required />
    </div>
    <div>
      <label>내용</label>
      <textarea name="content" rows="6" required>{{ article.content }}</textarea>
    </div>
    <button type="submit">저장</button>
  </form>
{% endblock %}
```

```text
# HTTP 상태 코드 요약
200 OK       — 정상 응답
302 Found    — redirect 응답(PRG에서 POST 후 GET 유도)
403 Forbidden— CSRF 누락/권한 부족
405 Method Not Allowed — 라우팅은 맞지만 지원하지 않는 메서드
```

# 🛠️ 이슈 & 해결
| 🐞 문제 상황 | 🔍 원인 | 💡 해결 방법 |
|--------------|--------|--------------|
| 새 글 POST에 403 발생 | CSRF 토큰 누락 | 템플릿 폼에 `{% csrf_token %}` 추가, 기본 미들웨어 유지 |
| 새로고침 시 중복 생성 | POST 후 바로 템플릿 응답 | **PRG 패턴** 사용 → `redirect()`로 상세/목록 GET 유도 |
| 삭제를 링크로 처리 | GET으로 파괴적 작업 | **POST 폼 + CSRF**로만 삭제 수행 |
| 수정 폼에 기존 내용 미표시 | input/textarea 채우는 방식 혼동 | input은 `value`, textarea는 **태그 사이**에 값 |
| 405 Method Not Allowed | URL은 맞는데 메서드 불일치 | 폼 `method` 확인, 뷰에서 `request.method` 분기/리다이렉트 |

# 🎯 내일 할 일
- 📚 Django **Form/ModelForm**로 입력 검증·렌더링 자동화, 에러 메시지 처리
- 💻 메시지 프레임워크(`django.contrib.messages`)로 생성/수정/삭제 알림 UX 개선
- 🔍 삭제 확인 페이지/모달 적용, 권한(로그인 사용자만 쓰기) 데코레이터 적용
