# 2025-09-24 TIL

# ✅ 오늘 한 일
- **ORM 개념**과 Django에서의 역할(파이썬 객체 ↔ DB 레코드 매핑) 정리
- **QuerySet API** 동작(지연 평가, 체이닝, Manager) 및 CRUD 실습
- **Field lookups**(exact/iexact, contains/icontains, gte/lt 등) 패턴 정리
- **ORM with view**로 목록 페이지 구성(뷰 → 템플릿 데이터 흐름)

# 📚 배운 점
- **ORM = 번역자**: 파이썬 코드로 작성한 질의를 SQL로 변환하고, 결과를 파이썬 객체/QuerySet으로 되돌려준다.
- **QuerySet은 지연 평가(lazy)**: 실제로 필요해질 때(순회/len()/리스트화/템플릿 렌더링 등) DB에 접근한다.
- **Manager (`objects`)**를 통해 질의를 시작하고, **체이닝**으로 조건을 누적한다(`filter().exclude().order_by()`).
- **get vs filter**: `get()`은 단일 객체(고유 키)에만 안전, 없거나 여러 개면 예외. 범용 조회는 `filter()` 사용.
- **Field lookups**로 SQL 비교/부분검색을 파이썬 문법으로 표현(`title__icontains="..."`, `id__gte=10`).

# 📌 핵심 개념
- **QuerySet 기본 구조**: `Article.objects.all()` / `Article.objects.filter(title__icontains="...")`
- **CRUD 요약**
  - Create: `Article(...).save()` / `Article.objects.create(...)`
  - Read: `all()`, `filter()`, `get()`, `order_by()`, `values()/values_list()`
  - Update: 인스턴스 필드 수정 후 `save(update_fields=[...])`
  - Delete: 인스턴스 `delete()` / `QuerySet.delete()`
- **예외**
  - `DoesNotExist`, `MultipleObjectsReturned` (주로 `get()` 사용 시)
  - `IntegrityError` (NOT NULL, unique 제약 위반)
- **ORM with view**
  - View에서 QuerySet 생성 → context로 템플릿에 전달 → 템플릿에서 반복 출력

# 💡 예시 코드
```python
# articles/models.py (예시 모델)
from django.db import models

class Article(models.Model):
    title = models.CharField(max_length=100)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.title
```

```python
# ── Django shell에서 CRUD ──
from articles.models import Article
# Create
a = Article(title="first", content="hello")
a.save()                                # 1) 빈 객체 후 save
Article.objects.create(title="second", content="world")  # 2) 한 번에 생성

# Read
Article.objects.all()                   # 전체
Article.objects.filter(title__icontains="sec")   # 부분검색
Article.objects.filter(id__gte=2).order_by("-id")# 정렬
Article.objects.get(pk=1)               # 단일(없거나 여러개면 예외)

# Update
art = Article.objects.get(pk=1)
art.title = "first (edited)"
art.save(update_fields=["title"])

# Delete
art.delete()                            # 단일 삭제
Article.objects.filter(title__icontains="old").delete()  # 일괄 삭제
```

```python
# ── Field lookups 모음 ──
Article.objects.filter(title__exact="first")         # 대소문자 구분
Article.objects.filter(title__iexact="First")        # 대소문자 무시
Article.objects.filter(title__startswith="fir")      # 접두
Article.objects.filter(title__icontains="st")        # 포함(대소문자 무시)
Article.objects.filter(id__range=(3, 10))            # 구간
Article.objects.filter(created_at__date__gte="2025-09-01")  # 날짜 비교
```

```python
# ── ORM with view ──  (목록 페이지)
from django.shortcuts import render
from .models import Article

def index(request):
    articles = Article.objects.all().order_by("-id")   # 지연 평가 → 템플릿 렌더링 시 쿼리
    return render(request, "articles/index.html", {"articles": articles})
```

```html
<!-- templates/articles/index.html -->
{% extends "base.html" %}
{% block content %}
  <h1>Articles</h1>
  <ul>
  {% for a in articles %}
    <li>[{{ a.id }}] {{ a.title }} — {{ a.created_at|date:"Y-m-d H:i" }}</li>
  {% empty %}
    <li>게시글이 없습니다.</li>
  {% endfor %}
  </ul>
{% endblock %}
```

```python
# ── 안전한 get 사용 패턴 ──
from django.http import Http404
from django.shortcuts import get_object_or_404

# 1) try/except
try:
    obj = Article.objects.get(pk=pk)
except Article.DoesNotExist:
    raise Http404("해당 글이 없습니다.")

# 2) 헬퍼
obj = get_object_or_404(Article, pk=pk)
```

# 🛠️ 이슈 & 해결
| 🐞 문제 상황 | 🔍 원인 | 💡 해결 방법 |
|--------------|--------|--------------|
| `DoesNotExist` 예외 | `get()`로 존재하지 않는 PK 조회 | `get_object_or_404()` 사용 또는 `filter().first()`로 안전 처리 |
| `MultipleObjectsReturned` | `get()`에 유일하지 않은 조건 사용 | `filter()` 사용, 또는 필드에 `unique=True` 부여 |
| `IntegrityError` (NOT NULL 등) | 필수 필드 비우고 저장 | 모델 옵션 재검토(`null/blank/default`) 후 저장 |
| 쿼리 성능 저하 | 무분별한 순회/템플릿 N+1 | `select_related()/prefetch_related()` 적용, 필요한 필드만 `values()` |
| 잘못된 정렬/슬라이싱 | 쿼리셋 평가 타이밍 혼동 | 체이닝 순서 점검(`order_by` 후 `[:N]`), 필요한 시점에만 평가 |

# 🎯 내일 할 일
- 📚 `get_object_or_404`, `select_related/prefetch_related` 심화 및 N+1 사례 분석
- 💻 Article **CRUD** 전체 뷰/템플릿 작성, URL 네임스페이스 연결
- 🔍 `values()/values_list()`와 `annotate()`(집계) 연습, QuerySet 디버깅(sqlprint) 습관화
